- name: install dependencies
  yum: name={{item}} enablerepo=epel state=installed
  with_items:
    - autoconf
    - re2c
    - libmcrypt
    - libmcrypt-devel
    - libxml2-devel
    - bison
    - bison-devel
    - openssl-devel
    - curl-devel
    - libjpeg-devel
    - libpng-devel
    - libmcrypt-devel
    - readline-devel
    - libtidy-devel
    - libxslt-devel
    - httpd-devel
    - enchant-devel
    - libXpm
    - libXpm-devel
    - freetype-devel
    - t1lib
    - t1lib-devel
    - gmp-devel
    - libc-client-devel
    - libicu-devel
    - oniguruma-devel
    - net-snmp
    - net-snmp-devel
    - bzip2-devel
    - mysql-devel
    - gd-devel
    - firebird-devel
    - freetds-devel
    - unixODBC-devel
    - aspell-devel
    - libedit-devel
    - net-snmp-devel
    - recode-devel
    - openssl
    - openssl-devel
    - libtool-ltdl-devel
    - lemon

- name: deploy configure option
  template: src=default_configure_options.j2 dest=/usr/local/phpenv/plugins/php-build/share/php-build/default_configure_options
  tags: php-build-install-php

- name: deploy php definitions {{ php_version }}
  template: src={{ php_version }}.j2 dest=/usr/local/phpenv/plugins/php-build/share/php-build/definitions/{{ php_version }}
  tags: php-build-install-php

- name: deploy php.conf to /etc/httpd/conf.d/php.conf
  template: src=php.conf.j2 dest=/etc/httpd/conf.d/php.conf
  register: deploy_php_conf
  tags: php-build-install-php

- name: Check phpenv Version Installed
  shell: source /etc/profile; phpenv versions | awk '/{{ php_version }}/{print $2}'
  register: result
  changed_when: result.stdout.find('{{ php_version }}') != 0
  tags: php-build-install-php

- name: Install PHP from phpenv
  shell: source /etc/profile; phpenv install {{ php_version }}
  when: result.stdout.find('{{ php_version }}') != 0
  tags: php-build-install-php

- name: Build phpenv change global
  shell: source /etc/profile; phpenv global {{ php_version }}; phpenv rehash
  when: result.stdout.find('{{ php_version }}') != 0
  tags: php-build-install-php

- name: changed libphp5.so permission
  file: path=/usr/lib64/httpd/modules/libphp5.so mode=775
  when: result.stdout.find('{{ php_version }}') != 0
  tags: php-build-install-php

- name: Copy libphp5.so phpenv/versions
  file: path=/usr/lib64/httpd/modules/libphp5.so dest=/usr/local/phpenv/versions/{{ php_version }}/
  when: result.stdout.find('{{ php_version }}') != 0
  tags: php-build-install-php

- name: Create directory /usr/local/phpenv/plugins
  file: path=/usr/local/phpenv/plugins state=directory mode=775
  tags: install-php-build

- name: check php-apache-version installed
  command: echo 'installed' creates=/usr/local/phpenv/plugins/phpenv-apache-version
  register: has_phpenv_apache_version
  tags: install-php-build

- name: install phpenv-apache-version
  git: repo=https://github.com/garamon/phpenv-apache-version.git
       dest=/usr/local/phpenv/plugins/phpenv-apache-version
  when: has_phpenv_apache_version|changed
  tags: install-php-build

- name: phpenv-apache version changed
  command: phpenv apache-version {{ php_version }}
  when: result.stdout.find('{{ php_version }}') != 0
  tags: php-build-install-php

- name: restart httpd
  service: name='httpd' state=restarted
  when: result.stdout.find('{{ php_version }}') != 0
  tags: php-build-install-php
